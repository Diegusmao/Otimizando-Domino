<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Visualizador de Rodada de Dominó</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f4f4f4; }
    .painel { margin: 20px 0; background: white; padding: 10px; border-radius: 6px; box-shadow: 0 1px 5px rgba(0,0,0,0.1); }
    .mao { margin: 5px 0; }
    .peca { 
      display: inline-flex;
      margin: 2px;
      background: #fff;
      border: 2px solid #333;
      border-radius: 4px;
      padding: 2px;
    }
    .peca-vertical {
      flex-direction: column;
    }
    .peca-horizontal {
      flex-direction: row;
      position: relative;
      top: 20px; /* Ajuste para centralizar com as peças verticais */
    }
    .metade {
      width: 30px;
      height: 30px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, 1fr);
      padding: 3px;
      gap: 1px;
    }
    .separador-vertical {
      height: 2px;
      background: #333;
      margin: 0 5px;
    }
    .separador-horizontal {
      width: 2px;
      background: #333;
      margin: 5px 0;
    }
    .pip {
      width: 6px;
      height: 6px;
      background: #333;
      border-radius: 50%;
      margin: auto;
    }
    .controle { margin-top: 10px; }
    button {
      padding: 8px 16px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 0 5px;
    }
    button:hover {
      background: #0056b3;
    }
    #tabuleiro {
      min-height: 100px; /* Espaço para as peças horizontais */
      display: flex;
      align-items: center;
      gap: 5px;
    }
  </style>
</head>
<body>
  <h1>Rodada de Dominó</h1>
  <button onclick="carregarRodada()">Simular Nova Rodada</button>
  <div class="painel">
    <h3>Jogada Atual</h3>
    <div id="info"></div>
    <h4>Tabuleiro</h4>
    <div id="tabuleiro"></div>
    <h4>Mãos</h4>
    <div id="maos"></div>
    <h4>Jogadas Disponíveis (Próximo Jogador)</h4>
    <div id="jogadas_disponiveis"></div>
    <div class="controle">
      <button onclick="voltar()">◀ Anterior</button>
      <button onclick="avancar()">Próxima ▶</button>
    </div>
  </div>
</body>

<script>
let dados = [];
let idx = 0;

function carregarRodada() {
  fetch('/simular')
    .then(res => res.json())
    .then(data => {
      dados = data.estados;
      idx = 0;
      mostrar();
    });
}

function criarPips(numero) {
  const posicoes = {
    0: [],
    1: [4],
    2: [2,6],
    3: [2,4,6],
    4: [0,2,6,8],
    5: [0,2,4,6,8],
    6: [0,2,3,5,6,8]
  };
  
  let html = '<div class="metade">';
  for (let i = 0; i < 9; i++) {
    html += posicoes[numero].includes(i) ? '<div class="pip"></div>' : '<div></div>';
  }
  html += '</div>';
  return html;
}

function formata(p, isBoard = false) {
  if (!p) return '';
  const isDuplo = p[0] === p[1];
  const orientation = isBoard && !isDuplo ? 'horizontal' : 'vertical';
  
  return `<div class="peca peca-${orientation}">
    ${criarPips(p[0])}
    <div class="separador-${orientation}"></div>
    ${criarPips(p[1])}
  </div>`;
}

function formataTexto(p) {
  return p ? `[${p[0]}|${p[1]}]` : '-';
}

function mostrar() {
  const estado = dados[idx];
  const proximoJogador = getProximoJogador(estado.jogador);
  const proximasJogadas = idx < dados.length - 1 ? dados[idx + 1].jogadas_disponiveis : [];
  
  document.getElementById("info").innerHTML =
  `<strong>Jogada #${estado.ordem_jogada}</strong> |
   Jogador: ${estado.jogador} |
   Tipo: ${estado.tipo} |
   Peça: ${formataTexto(estado.peca)} |
   Lado: ${estado.lado || '-'} |
   Tipo de Batida: ${estado.tipo_batida || '-'}`;

  document.getElementById("tabuleiro").innerHTML = estado.tabuleiro.map(p => formata(p, true)).join(' ');

  let htmlMaos = '';
  for (const j in estado.maos) {
    htmlMaos += `<div class="mao"><strong>${j}:</strong> ${estado.maos[j].map(p => formata(p, false)).join(' ')}</div>`;
  }
  document.getElementById("maos").innerHTML = htmlMaos;
  
  document.getElementById("jogadas_disponiveis").innerHTML = 
    `<strong>Próximo jogador (${proximoJogador}):</strong> ${proximasJogadas.map(p => formata(p, false)).join(' ') || '<em>Nenhuma</em>'}`;
}

function getProximoJogador(jogadorAtual) {
  const ordem = ["J1", "J2", "J3", "J4"];
  const idx = ordem.indexOf(jogadorAtual);
  return ordem[(idx + 1) % 4];
}

function avancar() {
  if (idx < dados.length - 1) idx++;
  mostrar();
}

function voltar() {
  if (idx > 0) idx--;
  mostrar();
}
</script>
</html>